<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canva Clone - Editor (Phase 4-A)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            overflow: hidden;
            background: #f5f5f5;
        }

        .editor-container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .header {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
            flex: 1;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            color: #5f57ff;
            cursor: pointer;
            white-space: nowrap;
        }

        .project-title {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            background: #f5f5f5;
            min-width: 200px;
        }

        .header-center {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar {
            height: 56px;
            background: white;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 8px;
            overflow-x: auto;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #f5f5f5;
            border-color: #5f57ff;
        }

        .toolbar-btn.active {
            background: #5f57ff;
            color: white;
            border-color: #5f57ff;
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e5e5;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid #e5e5e5;
        }

        .sidebar-tab {
            flex: 1;
            padding: 16px 12px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .sidebar-tab.active {
            border-bottom-color: #5f57ff;
            color: #5f57ff;
            font-weight: 600;
        }

        .sidebar-tab:hover {
            background: #f9f9f9;
        }

        .sidebar-content {
            padding: 20px;
            flex: 1;
        }

        .template-grid, .element-grid, .upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .template-item, .element-item, .upload-item {
            aspect-ratio: 1;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            overflow: hidden;
        }

        .template-item:hover, .element-item:hover, .upload-item:hover {
            transform: scale(1.05);
        }

        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .upload-box:hover {
            border-color: #5f57ff;
            background: #f9f9ff;
        }

        .upload-box.dragging {
            border-color: #5f57ff;
            background: #f0edff;
        }

        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: auto;
            position: relative;
        }

        .canvas-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 4px 24px rgba(0,0,0,0.12);
            border-radius: 4px;
        }

        .canvas {
            display: block;
        }

        .properties-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e5e5e5;
            overflow-y: auto;
            padding: 24px;
        }

        .property-group {
            margin-bottom: 24px;
        }

        .property-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .property-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .property-input:focus {
            border-color: #5f57ff;
        }

        .footer {
            height: 48px;
            background: white;
            border-top: 1px solid #e5e5e5;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-primary {
            padding: 10px 24px;
            background: #5f57ff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #4a3fff;
            transform: translateY(-1px);
        }

        .btn-secondary {
            padding: 8px 16px;
            background: white;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #f5f5f5;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }

        .save-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
        }

        .save-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }

        .save-indicator.saving {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .save-indicator.unsaved {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            padding: 8px 0;
            min-width: 180px;
            z-index: 10000;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-divider {
            height: 1px;
            background: #e5e5e5;
            margin: 4px 0;
        }

        .side-panel {
            position: fixed;
            right: 0;
            top: 60px;
            bottom: 48px;
            width: 360px;
            background: white;
            border-left: 1px solid #e5e5e5;
            box-shadow: -4px 0 16px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 50;
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .side-panel-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .version-item, .layer-item {
            padding: 16px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .version-item:hover, .layer-item:hover {
            border-color: #5f57ff;
            background: #f9f9ff;
        }

        .layer-item.selected {
            border-color: #5f57ff;
            background: #f0edff;
        }

        .layer-item.locked {
            opacity: 0.6;
            background: #f9f9f9;
        }

        .layer-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .layer-btn {
            padding: 4px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .layer-btn:hover {
            background: #f5f5f5;
        }

        .layer-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .presentation-mode {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: black;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .presentation-canvas {
            max-width: 90vw;
            max-height: 90vh;
        }

        .presentation-controls {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            background: rgba(255,255,255,0.1);
            padding: 16px 24px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .align-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .align-btn {
            padding: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .align-btn:hover {
            background: #f5f5f5;
            border-color: #5f57ff;
        }

        input[type="file"] {
            display: none;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #5f57ff;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #5f57ff;
            cursor: pointer;
            border: none;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #f0edff;
            color: #5f57ff;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .tooltip {
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: rgba(0,0,0,0.9);
            color: white;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 8px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API URL
        const API_URL = 'http://localhost:3001/api';

        // Auth Ïú†Ìã∏Î¶¨Ìã∞
        const auth = {
            getToken: () => localStorage.getItem('token'),
            getUser: () => {
                const user = localStorage.getItem('user');
                return user ? JSON.parse(user) : null;
            },
            logout: () => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            }
        };

        // API Ïú†Ìã∏Î¶¨Ìã∞
        const api = {
            getProject: async (token, id) => {
                const res = await fetch(`${API_URL}/projects/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to fetch project');
                return res.json();
            },
            updateProject: async (token, id, data) => {
                const res = await fetch(`${API_URL}/projects/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('Failed to update project');
                return res.json();
            },
            uploadFile: async (token, file) => {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (!res.ok) throw new Error('Failed to upload file');
                return res.json();
            },
            getUploads: async (token) => {
                const res = await fetch(`${API_URL}/uploads`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to fetch uploads');
                return res.json();
            },
            getVersions: async (token, projectId) => {
                const res = await fetch(`${API_URL}/projects/${projectId}/versions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to fetch versions');
                return res.json();
            },
            restoreVersion: async (token, projectId, versionId) => {
                const res = await fetch(`${API_URL}/projects/${projectId}/restore/${versionId}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Failed to restore version');
                return res.json();
            }
        };

        function Editor() {
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);

            // Í∏∞Î≥∏ ÏÉÅÌÉú
            const [user, setUser] = useState(null);
            const [projectId, setProjectId] = useState(null);
            const [projectTitle, setProjectTitle] = useState('ÏÉà ÎîîÏûêÏù∏');
            const [elements, setElements] = useState([]);
            const [selectedElement, setSelectedElement] = useState(null);
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [canvasSize, setCanvasSize] = useState({ width: 800, height: 1000 });
            const [zoom, setZoom] = useState(100);
            const [activeTab, setActiveTab] = useState('templates');
            const [saveStatus, setSaveStatus] = useState('saved');
            const [lastSaved, setLastSaved] = useState(new Date());

            // Phase 3 ÏÉÅÌÉúÎì§
            const [uploads, setUploads] = useState([]);
            const [uploading, setUploading] = useState(false);
            const [versions, setVersions] = useState([]);
            const [showVersions, setShowVersions] = useState(false);
            const [showLayers, setShowLayers] = useState(false);
            const [presentationMode, setPresentationMode] = useState(false);
            const [dragOver, setDragOver] = useState(false);

            // Phase 4-A ÏÉÅÌÉúÎì§
            const [contextMenu, setContextMenu] = useState(null);
            const [showAlignTools, setShowAlignTools] = useState(false);

            // Ï¥àÍ∏∞ Î°úÎìú
            useEffect(() => {
                const currentUser = auth.getUser();
                if (!currentUser) {
                    window.location.href = 'index.html';
                    return;
                }
                setUser(currentUser);

                const params = new URLSearchParams(window.location.search);
                const id = params.get('id');
                if (id) {
                    setProjectId(id);
                    loadProject(id);
                    loadUploads();
                    loadVersions(id);
                }
            }, []);

            // ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú
            const loadProject = async (id) => {
                const token = auth.getToken();
                try {
                    const data = await api.getProject(token, id);
                    setProjectTitle(data.title);
                    setElements(data.canvas_data || []);
                    setCanvasSize({
                        width: data.canvas_width || 800,
                        height: data.canvas_height || 1000
                    });
                    setHistory([data.canvas_data || []]);
                    setHistoryIndex(0);
                } catch (err) {
                    console.error('Failed to load project:', err);
                    alert('ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            };

            // ÏóÖÎ°úÎìú Î™©Î°ù Î°úÎìú
            const loadUploads = async () => {
                const token = auth.getToken();
                try {
                    const data = await api.getUploads(token);
                    setUploads(data || []);
                } catch (err) {
                    console.error('Failed to load uploads:', err);
                }
            };

            // Î≤ÑÏ†Ñ ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
            const loadVersions = async (id) => {
                const token = auth.getToken();
                try {
                    const data = await api.getVersions(token, id);
                    setVersions(data || []);
                } catch (err) {
                    console.error('Failed to load versions:', err);
                    setVersions([]);
                }
            };

            // ÏûêÎèô Ï†ÄÏû•
            useEffect(() => {
                if (!projectId || elements.length === 0) return;

                const timer = setTimeout(() => {
                    saveProject();
                }, 3000);

                return () => clearTimeout(timer);
            }, [elements, projectTitle]);

            // ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•
            const saveProject = async () => {
                if (!projectId) return;

                setSaveStatus('saving');
                const token = auth.getToken();

                try {
                    const canvas = canvasRef.current;
                    const thumbnail = canvas ? canvas.toDataURL('image/png') : null;

                    await api.updateProject(token, projectId, {
                        title: projectTitle,
                        canvas_data: elements,
                        canvas_width: canvasSize.width,
                        canvas_height: canvasSize.height,
                        thumbnail
                    });

                    setSaveStatus('saved');
                    setLastSaved(new Date());
                    loadVersions(projectId);
                } catch (err) {
                    console.error('Failed to save project:', err);
                    setSaveStatus('unsaved');
                }
            };

            // ÌååÏùº ÏóÖÎ°úÎìú
            const handleFileUpload = async (file) => {
                if (!file || !file.type.startsWith('image/')) {
                    alert('Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
                    return;
                }

                setUploading(true);
                const token = auth.getToken();

                try {
                    const result = await api.uploadFile(token, file);
                    setUploads(prev => [result.file, ...prev]);
                    alert('ÌååÏùºÏù¥ ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§!');
                    loadUploads();
                } catch (err) {
                    console.error('Failed to upload file:', err);
                    alert('ÌååÏùº ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                } finally {
                    setUploading(false);
                }
            };

            // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠
            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                const file = e.dataTransfer.files[0];
                if (file) handleFileUpload(file);
            };

            // Î≤ÑÏ†Ñ Î≥µÏõê
            const handleRestoreVersion = async (versionId) => {
                if (!confirm('Ïù¥ Î≤ÑÏ†ÑÏúºÎ°ú Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

                const token = auth.getToken();
                try {
                    const result = await api.restoreVersion(token, projectId, versionId);
                    setElements(result.canvas_data);
                    alert('Î≤ÑÏ†ÑÏù¥ Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.');
                    setShowVersions(false);
                } catch (err) {
                    console.error('Failed to restore version:', err);
                    alert('Î≤ÑÏ†Ñ Î≥µÏõêÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            };

            // ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä
            const addToHistory = (newElements) => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(newElements);
                setHistory(newHistory);
                setHistoryIndex(newHistory.length - 1);
                setSaveStatus('unsaved');
            };

            // Ïã§Ìñâ Ï∑®ÏÜå
            const undo = () => {
                if (historyIndex > 0) {
                    setHistoryIndex(historyIndex - 1);
                    setElements(history[historyIndex - 1]);
                }
            };

            // Îã§Ïãú Ïã§Ìñâ
            const redo = () => {
                if (historyIndex < history.length - 1) {
                    setHistoryIndex(historyIndex + 1);
                    setElements(history[historyIndex + 1]);
                }
            };

            // ÏöîÏÜå Ï∂îÍ∞Ä
            const addElement = (type, props = {}) => {
                const newElement = {
                    id: Date.now(),
                    type,
                    x: 100,
                    y: 100,
                    width: type === 'text' ? 200 : 150,
                    height: type === 'text' ? 50 : 150,
                    rotation: 0,
                    fill: type === 'rectangle' ? '#ff6b6b' : type === 'circle' ? '#4ecdc4' : type === 'triangle' ? '#ffe66d' : '#333',
                    opacity: 1,
                    shadow: null,
                    border: null,
                    gradient: null,
                    locked: false,
                    blendMode: 'normal',
                    ...props
                };

                const newElements = [...elements, newElement];
                setElements(newElements);
                addToHistory(newElements);
                setSelectedElement(newElement.id);
            };

            // ÏöîÏÜå Î≥µÏ†ú
            const duplicateElement = () => {
                if (!selectedElement) return;

                const element = elements.find(el => el.id === selectedElement);
                if (!element) return;

                const newElement = {
                    ...element,
                    id: Date.now(),
                    x: element.x + 20,
                    y: element.y + 20
                };

                const newElements = [...elements, newElement];
                setElements(newElements);
                addToHistory(newElements);
                setSelectedElement(newElement.id);
            };

            // ÏöîÏÜå ÏÇ≠Ï†ú
            const deleteElement = () => {
                if (!selectedElement) return;

                const newElements = elements.filter(el => el.id !== selectedElement);
                setElements(newElements);
                addToHistory(newElements);
                setSelectedElement(null);
            };

            // ÏöîÏÜå Ïû†Í∏à/Ïû†Í∏à Ìï¥Ï†ú
            const toggleLock = () => {
                if (!selectedElement) return;

                const newElements = elements.map(el =>
                    el.id === selectedElement ? { ...el, locked: !el.locked } : el
                );
                setElements(newElements);
                addToHistory(newElements);
            };

            // Ï†ïÎ†¨ Í∏∞Îä•
            const alignElements = (direction) => {
                if (!selectedElement) return;

                const element = elements.find(el => el.id === selectedElement);
                if (!element) return;

                let newX = element.x;
                let newY = element.y;

                switch (direction) {
                    case 'left':
                        newX = 0;
                        break;
                    case 'center-h':
                        newX = (canvasSize.width - element.width) / 2;
                        break;
                    case 'right':
                        newX = canvasSize.width - element.width;
                        break;
                    case 'top':
                        newY = 0;
                        break;
                    case 'center-v':
                        newY = (canvasSize.height - element.height) / 2;
                        break;
                    case 'bottom':
                        newY = canvasSize.height - element.height;
                        break;
                }

                const newElements = elements.map(el =>
                    el.id === selectedElement ? { ...el, x: newX, y: newY } : el
                );
                setElements(newElements);
                addToHistory(newElements);
            };

            // Î†àÏù¥Ïñ¥ ÏàúÏÑú Î≥ÄÍ≤Ω
            const moveLayer = (index, direction) => {
                const newElements = [...elements];
                const newIndex = index + direction;
                
                if (newIndex < 0 || newIndex >= newElements.length) return;
                
                const temp = newElements[index];
                newElements[index] = newElements[newIndex];
                newElements[newIndex] = temp;
                
                setElements(newElements);
                addToHistory(newElements);
            };

            // ÏÜçÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
            const updateElementProperty = (property, value) => {
                if (!selectedElement) return;

                const newElements = elements.map(el =>
                    el.id === selectedElement ? { ...el, [property]: value } : el
                );
                setElements(newElements);
            };

            // Ï∫îÎ≤ÑÏä§ Î†åÎçîÎßÅ
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvasSize.width, canvasSize.height);

                elements.forEach(element => {
                    ctx.save();
                    
                    // Î∂àÌà¨Î™ÖÎèÑ
                    ctx.globalAlpha = element.opacity || 1;

                    // Î∏îÎ†åÎìú Î™®Îìú
                    ctx.globalCompositeOperation = element.blendMode || 'source-over';

                    ctx.translate(element.x + element.width / 2, element.y + element.height / 2);
                    ctx.rotate((element.rotation || 0) * Math.PI / 180);

                    // Í∑∏Î¶ºÏûê
                    if (element.shadow) {
                        ctx.shadowColor = element.shadow.color || '#000';
                        ctx.shadowBlur = element.shadow.blur || 10;
                        ctx.shadowOffsetX = element.shadow.offsetX || 5;
                        ctx.shadowOffsetY = element.shadow.offsetY || 5;
                    }

                    // Í∑∏ÎùºÎîîÏñ∏Ìä∏
                    let fillStyle = element.fill || '#ff6b6b';
                    if (element.gradient) {
                        if (element.gradient.type === 'linear') {
                            const angle = (element.gradient.angle || 0) * Math.PI / 180;
                            const gradient = ctx.createLinearGradient(
                                -element.width / 2,
                                -element.height / 2,
                                element.width / 2,
                                element.height / 2
                            );
                            element.gradient.stops.forEach((stop, i) => {
                                gradient.addColorStop(i / (element.gradient.stops.length - 1), stop);
                            });
                            fillStyle = gradient;
                        } else if (element.gradient.type === 'radial') {
                            const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, element.width / 2);
                            element.gradient.stops.forEach((stop, i) => {
                                gradient.addColorStop(i / (element.gradient.stops.length - 1), stop);
                            });
                            fillStyle = gradient;
                        }
                    }

                    // ÎèÑÌòï Í∑∏Î¶¨Í∏∞
                    if (element.type === 'rectangle') {
                        if (element.border) {
                            ctx.strokeStyle = element.border.color || '#000';
                            ctx.lineWidth = element.border.width || 2;
                            ctx.strokeRect(-element.width / 2, -element.height / 2, element.width, element.height);
                        }
                        ctx.fillStyle = fillStyle;
                        ctx.fillRect(-element.width / 2, -element.height / 2, element.width, element.height);
                    } else if (element.type === 'circle') {
                        ctx.beginPath();
                        ctx.arc(0, 0, element.width / 2, 0, Math.PI * 2);
                        if (element.border) {
                            ctx.strokeStyle = element.border.color || '#000';
                            ctx.lineWidth = element.border.width || 2;
                            ctx.stroke();
                        }
                        ctx.fillStyle = fillStyle;
                        ctx.fill();
                    } else if (element.type === 'triangle') {
                        ctx.beginPath();
                        ctx.moveTo(0, -element.height / 2);
                        ctx.lineTo(-element.width / 2, element.height / 2);
                        ctx.lineTo(element.width / 2, element.height / 2);
                        ctx.closePath();
                        if (element.border) {
                            ctx.strokeStyle = element.border.color || '#000';
                            ctx.lineWidth = element.border.width || 2;
                            ctx.stroke();
                        }
                        ctx.fillStyle = fillStyle;
                        ctx.fill();
                    } else if (element.type === 'text') {
                        ctx.fillStyle = fillStyle;
                        ctx.font = `${element.fontSize || 24}px ${element.fontFamily || 'Arial'}`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(element.text || 'Text', 0, 0);
                    } else if (element.type === 'image' && element.src) {
                        const img = new Image();
                        img.src = element.src;
                        img.onload = () => {
                            ctx.drawImage(img, -element.width / 2, -element.height / 2, element.width, element.height);
                        };
                    }

                    ctx.restore();
                });
            }, [elements, canvasSize]);

            // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === 'z') {
                            e.preventDefault();
                            undo();
                        } else if (e.key === 'y') {
                            e.preventDefault();
                            redo();
                        } else if (e.key === 's') {
                            e.preventDefault();
                            saveProject();
                        } else if (e.key === 'd') {
                            e.preventDefault();
                            duplicateElement();
                        }
                    } else if (e.key === 'Delete' && selectedElement) {
                        deleteElement();
                    } else if (e.key === 'Escape') {
                        setSelectedElement(null);
                        setPresentationMode(false);
                        setContextMenu(null);
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [elements, selectedElement, historyIndex, history]);

            // Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ Îã´Í∏∞
            useEffect(() => {
                const handleClick = () => setContextMenu(null);
                window.addEventListener('click', handleClick);
                return () => window.removeEventListener('click', handleClick);
            }, []);

            // ÌîÑÎ†àÏ††ÌÖåÏù¥ÏÖò Î™®Îìú
            if (presentationMode) {
                return (
                    <div className="presentation-mode">
                        <canvas 
                            ref={canvasRef}
                            width={canvasSize.width}
                            height={canvasSize.height}
                            className="presentation-canvas"
                        />
                        <div className="presentation-controls">
                            <button 
                                className="btn-primary"
                                onClick={() => setPresentationMode(false)}
                            >
                                ESC: ÎÇòÍ∞ÄÍ∏∞
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="editor-container">
                    {/* Ìó§Îçî */}
                    <div className="header">
                        <div className="header-left">
                            <div className="logo" onClick={() => window.location.href = 'index.html'}>
                                Canva Clone
                            </div>
                            <input
                                type="text"
                                className="project-title"
                                value={projectTitle}
                                onChange={(e) => setProjectTitle(e.target.value)}
                                placeholder="ÌîÑÎ°úÏ†ùÌä∏ Ï†úÎ™©"
                            />
                            <span className="badge">Phase 4-A</span>
                        </div>

                        <div className="header-center">
                            <button className="toolbar-btn" onClick={() => setShowVersions(!showVersions)}>
                                üìú Î≤ÑÏ†Ñ
                            </button>
                            <button className="toolbar-btn" onClick={() => setShowLayers(!showLayers)}>
                                üóÇÔ∏è Î†àÏù¥Ïñ¥
                            </button>
                            <button 
                                className="toolbar-btn" 
                                onClick={() => setShowAlignTools(!showAlignTools)}
                                disabled={!selectedElement}
                            >
                                ‚ö° Ï†ïÎ†¨
                            </button>
                            <button className="toolbar-btn" onClick={() => setPresentationMode(true)}>
                                ‚ñ∂Ô∏è Î∞úÌëú
                            </button>
                        </div>

                        <div className="header-right">
                            <div className="save-status">
                                <div className={`save-indicator ${saveStatus}`}></div>
                                <span>
                                    {saveStatus === 'saved' && 'Ï†ÄÏû•Îê®'}
                                    {saveStatus === 'saving' && 'Ï†ÄÏû• Ï§ë...'}
                                    {saveStatus === 'unsaved' && 'Ï†ÄÏû• ÏïàÎê®'}
                                </span>
                            </div>
                            <button className="btn-primary" onClick={saveProject}>
                                üíæ Ï†ÄÏû•
                            </button>
                            <div className="user-avatar" onClick={auth.logout}>
                                {user?.name?.charAt(0)}
                            </div>
                        </div>
                    </div>

                    {/* Ìà¥Î∞î */}
                    <div className="toolbar">
                        <button className="toolbar-btn" onClick={undo} disabled={historyIndex <= 0}>
                            ‚Ü∂ Ïã§Ìñâ Ï∑®ÏÜå
                        </button>
                        <button className="toolbar-btn" onClick={redo} disabled={historyIndex >= history.length - 1}>
                            ‚Ü∑ Îã§Ïãú Ïã§Ìñâ
                        </button>
                        <div style={{ width: '1px', height: '24px', background: '#ddd', margin: '0 8px' }}></div>
                        <button className="toolbar-btn" onClick={() => addElement('rectangle')}>
                            ‚ñ¢ ÏÇ¨Í∞ÅÌòï
                        </button>
                        <button className="toolbar-btn" onClick={() => addElement('circle')}>
                            ‚óè Ïõê
                        </button>
                        <button className="toolbar-btn" onClick={() => addElement('triangle')}>
                            ‚ñ≤ ÏÇºÍ∞ÅÌòï
                        </button>
                        <button className="toolbar-btn" onClick={() => addElement('text', { text: 'Text', fontSize: 32 })}>
                            T ÌÖçÏä§Ìä∏
                        </button>
                        <div style={{ width: '1px', height: '24px', background: '#ddd', margin: '0 8px' }}></div>
                        <button 
                            className="toolbar-btn tooltip" 
                            onClick={duplicateElement} 
                            disabled={!selectedElement}
                            data-tooltip="Ctrl+D"
                        >
                            üìã Î≥µÏ†ú
                        </button>
                        <button 
                            className="toolbar-btn tooltip" 
                            onClick={deleteElement} 
                            disabled={!selectedElement}
                            data-tooltip="Delete"
                        >
                            üóëÔ∏è ÏÇ≠Ï†ú
                        </button>
                        <button 
                            className="toolbar-btn tooltip" 
                            onClick={toggleLock} 
                            disabled={!selectedElement}
                            data-tooltip="ÏöîÏÜå Ïû†Í∏à/Ìï¥Ï†ú"
                        >
                            {selectedElement && elements.find(el => el.id === selectedElement)?.locked ? 'üîí Ïû†Í∏àÎê®' : 'üîì Ïû†Í∏à Ìï¥Ï†ú'}
                        </button>
                    </div>

                    {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
                    <div className="main-content">
                        {/* ÏÇ¨Ïù¥ÎìúÎ∞î */}
                        <div className="sidebar">
                            <div className="sidebar-tabs">
                                <button
                                    className={`sidebar-tab ${activeTab === 'templates' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('templates')}
                                >
                                    üìê ÌÖúÌîåÎ¶ø
                                </button>
                                <button
                                    className={`sidebar-tab ${activeTab === 'elements' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('elements')}
                                >
                                    ‚≠ê ÏöîÏÜå
                                </button>
                                <button
                                    className={`sidebar-tab ${activeTab === 'text' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('text')}
                                >
                                    T ÌÖçÏä§Ìä∏
                                </button>
                                <button
                                    className={`sidebar-tab ${activeTab === 'uploads' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('uploads')}
                                >
                                    üì§ ÏóÖÎ°úÎìú
                                </button>
                            </div>

                            <div className="sidebar-content">
                                {activeTab === 'templates' && (
                                    <>
                                        <div className="section-title">ÏÜåÏÖú ÎØ∏ÎîîÏñ¥</div>
                                        <div className="template-grid">
                                            {['Instagram Post', 'Instagram Story', 'Facebook Post', 'Twitter Post'].map(name => (
                                                <div
                                                    key={name}
                                                    className="template-item"
                                                    style={{ background: '#f0f0f0' }}
                                                >
                                                    {name}
                                                </div>
                                            ))}
                                        </div>
                                        <div className="section-title">ÌîÑÎ¶∞Ìä∏</div>
                                        <div className="template-grid">
                                            {['YouTube Thumbnail', 'LinkedIn Post'].map(name => (
                                                <div
                                                    key={name}
                                                    className="template-item"
                                                    style={{ background: '#f0f0f0' }}
                                                >
                                                    {name}
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}

                                {activeTab === 'elements' && (
                                    <>
                                        <div className="section-title">ÎèÑÌòï</div>
                                        <div className="element-grid">
                                            <div
                                                className="element-item"
                                                style={{ background: '#ff6b6b' }}
                                                onClick={() => addElement('rectangle')}
                                            >
                                                ÏÇ¨Í∞ÅÌòï
                                            </div>
                                            <div
                                                className="element-item"
                                                style={{ background: '#4ecdc4', borderRadius: '50%' }}
                                                onClick={() => addElement('circle')}
                                            >
                                                Ïõê
                                            </div>
                                            <div
                                                className="element-item"
                                                style={{ background: '#ffe66d', clipPath: 'polygon(50% 0%, 0% 100%, 100% 100%)' }}
                                                onClick={() => addElement('triangle')}
                                            >
                                            </div>
                                        </div>
                                    </>
                                )}

                                {activeTab === 'text' && (
                                    <>
                                        <div className="section-title">ÌÖçÏä§Ìä∏ Ï∂îÍ∞Ä</div>
                                        <button
                                            className="btn-primary"
                                            style={{ width: '100%', marginBottom: '16px' }}
                                            onClick={() => addElement('text', { text: 'Ï†úÎ™© Ï∂îÍ∞Ä', fontSize: 48 })}
                                        >
                                            + Ï†úÎ™© Ï∂îÍ∞Ä
                                        </button>
                                        <button
                                            className="btn-secondary"
                                            style={{ width: '100%', marginBottom: '16px' }}
                                            onClick={() => addElement('text', { text: 'Î∂ÄÏ†úÎ™© Ï∂îÍ∞Ä', fontSize: 32 })}
                                        >
                                            + Î∂ÄÏ†úÎ™© Ï∂îÍ∞Ä
                                        </button>
                                        <button
                                            className="btn-secondary"
                                            style={{ width: '100%' }}
                                            onClick={() => addElement('text', { text: 'Î≥∏Î¨∏ ÌÖçÏä§Ìä∏', fontSize: 18 })}
                                        >
                                            + Î≥∏Î¨∏ ÌÖçÏä§Ìä∏
                                        </button>
                                    </>
                                )}

                                {activeTab === 'uploads' && (
                                    <>
                                        <div className="section-title">Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</div>
                                        <div
                                            className={`upload-box ${dragOver ? 'dragging' : ''}`}
                                            onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
                                            onDragLeave={() => setDragOver(false)}
                                            onDrop={handleDrop}
                                            onClick={() => fileInputRef.current?.click()}
                                        >
                                            {uploading ? (
                                                <div>ÏóÖÎ°úÎìú Ï§ë...</div>
                                            ) : (
                                                <>
                                                    <div style={{ fontSize: '32px', marginBottom: '8px' }}>üìÅ</div>
                                                    <div style={{ fontSize: '14px', color: '#666' }}>
                                                        Ïù¥ÎØ∏ÏßÄÎ•º ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏóÖÎ°úÎìú
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept="image/*"
                                            onChange={(e) => handleFileUpload(e.target.files[0])}
                                        />

                                        {uploads.length > 0 && (
                                            <>
                                                <div className="section-title">ÏóÖÎ°úÎìúÎêú Ïù¥ÎØ∏ÏßÄ</div>
                                                <div className="upload-grid">
                                                    {uploads.map(upload => (
                                                        <div
                                                            key={upload.id}
                                                            className="upload-item"
                                                            style={{
                                                                backgroundImage: `url(${upload.url})`,
                                                                backgroundSize: 'cover',
                                                                backgroundPosition: 'center'
                                                            }}
                                                            onClick={() => addElement('image', { src: upload.url })}
                                                        />
                                                    ))}
                                                </div>
                                            </>
                                        )}
                                    </>
                                )}
                            </div>
                        </div>

                        {/* Ï∫îÎ≤ÑÏä§ */}
                        <div className="canvas-area">
                            <div className="canvas-wrapper" style={{ transform: `scale(${zoom / 100})` }}>
                                <canvas
                                    ref={canvasRef}
                                    width={canvasSize.width}
                                    height={canvasSize.height}
                                    className="canvas"
                                    style={{ cursor: selectedElement ? 'move' : 'default' }}
                                    onClick={(e) => {
                                        const rect = canvasRef.current.getBoundingClientRect();
                                        const scaleX = canvasSize.width / rect.width;
                                        const scaleY = canvasSize.height / rect.height;
                                        const x = (e.clientX - rect.left) * scaleX;
                                        const y = (e.clientY - rect.top) * scaleY;

                                        let clickedElement = null;
                                        for (let i = elements.length - 1; i >= 0; i--) {
                                            const el = elements[i];
                                            if (x >= el.x && x <= el.x + el.width &&
                                                y >= el.y && y <= el.y + el.height) {
                                                clickedElement = el.id;
                                                break;
                                            }
                                        }

                                        if (clickedElement) {
                                            setSelectedElement(clickedElement);
                                        } else {
                                            setSelectedElement(null);
                                        }
                                    }}
                                    onMouseDown={(e) => {
                                        if (!selectedElement) return;

                                        const element = elements.find(el => el.id === selectedElement);
                                        if (!element || element.locked) return;

                                        e.preventDefault();

                                        const rect = canvasRef.current.getBoundingClientRect();
                                        const scaleX = canvasSize.width / rect.width;
                                        const scaleY = canvasSize.height / rect.height;

                                        const startX = e.clientX;
                                        const startY = e.clientY;
                                        const startElementX = element.x;
                                        const startElementY = element.y;

                                        const handleMouseMove = (moveEvent) => {
                                            const deltaX = (moveEvent.clientX - startX) * scaleX;
                                            const deltaY = (moveEvent.clientY - startY) * scaleY;

                                            const newElements = elements.map(el =>
                                                el.id === selectedElement
                                                    ? { 
                                                        ...el, 
                                                        x: Math.max(0, Math.min(canvasSize.width - el.width, startElementX + deltaX)),
                                                        y: Math.max(0, Math.min(canvasSize.height - el.height, startElementY + deltaY))
                                                      }
                                                    : el
                                            );
                                            setElements(newElements);
                                        };

                                        const handleMouseUp = () => {
                                            document.removeEventListener('mousemove', handleMouseMove);
                                            document.removeEventListener('mouseup', handleMouseUp);
                                            addToHistory(elements);
                                        };

                                        document.addEventListener('mousemove', handleMouseMove);
                                        document.addEventListener('mouseup', handleMouseUp);
                                    }}
                                    onContextMenu={(e) => {
                                        e.preventDefault();
                                        if (selectedElement) {
                                            setContextMenu({ x: e.clientX, y: e.clientY });
                                        }
                                    }}
                                />

                                {/* ÏÑ†ÌÉùÎêú ÏöîÏÜå ÌëúÏãú */}
                                {selectedElement && (() => {
                                    const element = elements.find(el => el.id === selectedElement);
                                    if (!element) return null;

                                    return (
                                        <div
                                            style={{
                                                position: 'absolute',
                                                left: element.x,
                                                top: element.y,
                                                width: element.width,
                                                height: element.height,
                                                border: '2px solid #5f57ff',
                                                pointerEvents: 'none',
                                                boxSizing: 'border-box'
                                            }}
                                        >
                                            {/* Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§ */}
                                            <div
                                                style={{
                                                    position: 'absolute',
                                                    right: -6,
                                                    bottom: -6,
                                                    width: 12,
                                                    height: 12,
                                                    background: '#5f57ff',
                                                    border: '2px solid white',
                                                    borderRadius: '50%',
                                                    cursor: 'nwse-resize',
                                                    pointerEvents: 'auto'
                                                }}
                                                onMouseDown={(e) => {
                                                    if (element.locked) return;
                                                    e.stopPropagation();

                                                    const rect = canvasRef.current.getBoundingClientRect();
                                                    const scaleX = canvasSize.width / rect.width;
                                                    const scaleY = canvasSize.height / rect.height;

                                                    const startX = e.clientX;
                                                    const startY = e.clientY;
                                                    const startWidth = element.width;
                                                    const startHeight = element.height;

                                                    const handleMouseMove = (moveEvent) => {
                                                        const deltaX = (moveEvent.clientX - startX) * scaleX;
                                                        const deltaY = (moveEvent.clientY - startY) * scaleY;

                                                        const newElements = elements.map(el =>
                                                            el.id === selectedElement
                                                                ? {
                                                                    ...el,
                                                                    width: Math.max(20, startWidth + deltaX),
                                                                    height: Math.max(20, startHeight + deltaY)
                                                                  }
                                                                : el
                                                        );
                                                        setElements(newElements);
                                                    };

                                                    const handleMouseUp = () => {
                                                        document.removeEventListener('mousemove', handleMouseMove);
                                                        document.removeEventListener('mouseup', handleMouseUp);
                                                        addToHistory(elements);
                                                    };

                                                    document.addEventListener('mousemove', handleMouseMove);
                                                    document.addEventListener('mouseup', handleMouseUp);
                                                }}
                                            />
                                        </div>
                                    );
                                })()}
                            </div>
                        </div>

                        {/* ÏÜçÏÑ± Ìå®ÎÑê */}
                        {selectedElement && (() => {
                            const element = elements.find(el => el.id === selectedElement);
                            if (!element) return null;

                            return (
                                <div className="properties-panel">
                                    <div className="section-title">
                                        ÏÜçÏÑ±
                                        {element.locked && <span className="badge">üîí Ïû†Í∏à</span>}
                                    </div>
                                    
                                    {/* ÏúÑÏπò */}
                                    <div className="property-group">
                                        <label className="property-label">ÏúÑÏπò</label>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                                            <input
                                                type="number"
                                                className="property-input"
                                                value={Math.round(element.x)}
                                                onChange={(e) => updateElementProperty('x', parseInt(e.target.value))}
                                                disabled={element.locked}
                                            />
                                            <input
                                                type="number"
                                                className="property-input"
                                                value={Math.round(element.y)}
                                                onChange={(e) => updateElementProperty('y', parseInt(e.target.value))}
                                                disabled={element.locked}
                                            />
                                        </div>
                                    </div>

                                    {/* ÌÅ¨Í∏∞ */}
                                    <div className="property-group">
                                        <label className="property-label">ÌÅ¨Í∏∞</label>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                                            <input
                                                type="number"
                                                className="property-input"
                                                value={Math.round(element.width)}
                                                onChange={(e) => updateElementProperty('width', parseInt(e.target.value))}
                                                disabled={element.locked}
                                            />
                                            <input
                                                type="number"
                                                className="property-input"
                                                value={Math.round(element.height)}
                                                onChange={(e) => updateElementProperty('height', parseInt(e.target.value))}
                                                disabled={element.locked}
                                            />
                                        </div>
                                    </div>

                                    {/* ÌöåÏ†Ñ */}
                                    <div className="property-group">
                                        <label className="property-label">ÌöåÏ†Ñ: {element.rotation || 0}¬∞</label>
                                        <input
                                            type="range"
                                            min="0"
                                            max="360"
                                            value={element.rotation || 0}
                                            onChange={(e) => updateElementProperty('rotation', parseInt(e.target.value))}
                                            disabled={element.locked}
                                        />
                                    </div>

                                    {/* Î∂àÌà¨Î™ÖÎèÑ */}
                                    <div className="property-group">
                                        <label className="property-label">Î∂àÌà¨Î™ÖÎèÑ: {Math.round((element.opacity || 1) * 100)}%</label>
                                        <input
                                            type="range"
                                            min="0"
                                            max="100"
                                            value={(element.opacity || 1) * 100}
                                            onChange={(e) => updateElementProperty('opacity', parseInt(e.target.value) / 100)}
                                            disabled={element.locked}
                                        />
                                    </div>

                                    {/* ÏÉâÏÉÅ */}
                                    {element.type !== 'image' && (
                                        <div className="property-group">
                                            <label className="property-label">ÏÉâÏÉÅ</label>
                                            <input
                                                type="color"
                                                className="property-input"
                                                value={element.fill || '#ff6b6b'}
                                                onChange={(e) => updateElementProperty('fill', e.target.value)}
                                                disabled={element.locked}
                                            />
                                        </div>
                                    )}

                                    {/* Í∑∏ÎùºÎîîÏñ∏Ìä∏ */}
                                    {element.type !== 'image' && element.type !== 'text' && (
                                        <div className="property-group">
                                            <label className="property-label">Í∑∏ÎùºÎîîÏñ∏Ìä∏</label>
                                            <button
                                                className="btn-secondary"
                                                style={{ width: '100%', marginBottom: '8px' }}
                                                onClick={() => {
                                                    updateElementProperty('gradient', {
                                                        type: 'linear',
                                                        angle: 90,
                                                        stops: ['#ff6b6b', '#4ecdc4']
                                                    });
                                                }}
                                                disabled={element.locked}
                                            >
                                                ÏÑ†Ìòï Í∑∏ÎùºÎîîÏñ∏Ìä∏
                                            </button>
                                            <button
                                                className="btn-secondary"
                                                style={{ width: '100%', marginBottom: '8px' }}
                                                onClick={() => {
                                                    updateElementProperty('gradient', {
                                                        type: 'radial',
                                                        stops: ['#ff6b6b', '#4ecdc4']
                                                    });
                                                }}
                                                disabled={element.locked}
                                            >
                                                ÏõêÌòï Í∑∏ÎùºÎîîÏñ∏Ìä∏
                                            </button>
                                            {element.gradient && (
                                                <button
                                                    className="btn-secondary"
                                                    style={{ width: '100%' }}
                                                    onClick={() => updateElementProperty('gradient', null)}
                                                    disabled={element.locked}
                                                >
                                                    Í∑∏ÎùºÎîîÏñ∏Ìä∏ Ï†úÍ±∞
                                                </button>
                                            )}
                                        </div>
                                    )}

                                    {/* Í∑∏Î¶ºÏûê */}
                                    <div className="property-group">
                                        <label className="property-label">Í∑∏Î¶ºÏûê</label>
                                        <button
                                            className="btn-secondary"
                                            style={{ width: '100%', marginBottom: '8px' }}
                                            onClick={() => {
                                                if (element.shadow) {
                                                    updateElementProperty('shadow', null);
                                                } else {
                                                    updateElementProperty('shadow', {
                                                        blur: 10,
                                                        color: 'rgba(0,0,0,0.3)',
                                                        offsetX: 5,
                                                        offsetY: 5
                                                    });
                                                }
                                            }}
                                            disabled={element.locked}
                                        >
                                            {element.shadow ? 'Í∑∏Î¶ºÏûê Ï†úÍ±∞' : 'Í∑∏Î¶ºÏûê Ï∂îÍ∞Ä'}
                                        </button>
                                    </div>

                                    {/* ÌÖåÎëêÎ¶¨ */}
                                    <div className="property-group">
                                        <label className="property-label">ÌÖåÎëêÎ¶¨</label>
                                        <button
                                            className="btn-secondary"
                                            style={{ width: '100%', marginBottom: '8px' }}
                                            onClick={() => {
                                                if (element.border) {
                                                    updateElementProperty('border', null);
                                                } else {
                                                    updateElementProperty('border', {
                                                        width: 3,
                                                        color: '#000'
                                                    });
                                                }
                                            }}
                                            disabled={element.locked}
                                        >
                                            {element.border ? 'ÌÖåÎëêÎ¶¨ Ï†úÍ±∞' : 'ÌÖåÎëêÎ¶¨ Ï∂îÍ∞Ä'}
                                        </button>
                                        {element.border && (
                                            <>
                                                <label className="property-label" style={{ fontSize: '12px', marginTop: '8px' }}>
                                                    ÎëêÍªò: {element.border.width}px
                                                </label>
                                                <input
                                                    type="range"
                                                    min="1"
                                                    max="20"
                                                    value={element.border.width}
                                                    onChange={(e) => {
                                                        updateElementProperty('border', {
                                                            ...element.border,
                                                            width: parseInt(e.target.value)
                                                        });
                                                    }}
                                                    disabled={element.locked}
                                                />
                                                <input
                                                    type="color"
                                                    className="property-input"
                                                    value={element.border.color}
                                                    onChange={(e) => {
                                                        updateElementProperty('border', {
                                                            ...element.border,
                                                            color: e.target.value
                                                        });
                                                    }}
                                                    disabled={element.locked}
                                                    style={{ marginTop: '8px' }}
                                                />
                                            </>
                                        )}
                                    </div>

                                    {/* ÌÖçÏä§Ìä∏ ÏÜçÏÑ± */}
                                    {element.type === 'text' && (
                                        <>
                                            <div className="property-group">
                                                <label className="property-label">ÌÖçÏä§Ìä∏</label>
                                                <input
                                                    type="text"
                                                    className="property-input"
                                                    value={element.text || ''}
                                                    onChange={(e) => updateElementProperty('text', e.target.value)}
                                                    disabled={element.locked}
                                                />
                                            </div>
                                            <div className="property-group">
                                                <label className="property-label">Í∏ÄÏûê ÌÅ¨Í∏∞</label>
                                                <input
                                                    type="number"
                                                    className="property-input"
                                                    value={element.fontSize || 24}
                                                    onChange={(e) => updateElementProperty('fontSize', parseInt(e.target.value))}
                                                    disabled={element.locked}
                                                />
                                            </div>
                                        </>
                                    )}

                                    {/* Ï†ïÎ†¨ ÎèÑÍµ¨ */}
                                    {showAlignTools && (
                                        <div className="property-group">
                                            <label className="property-label">Ï†ïÎ†¨</label>
                                            <div className="align-buttons">
                                                <button className="align-btn" onClick={() => alignElements('left')} title="ÏôºÏ™Ω">‚Üê</button>
                                                <button className="align-btn" onClick={() => alignElements('center-h')} title="Í∞ÄÏö¥Îç∞(Í∞ÄÎ°ú)">‚Üî</button>
                                                <button className="align-btn" onClick={() => alignElements('right')} title="Ïò§Î•∏Ï™Ω">‚Üí</button>
                                                <button className="align-btn" onClick={() => alignElements('top')} title="ÏúÑ">‚Üë</button>
                                                <button className="align-btn" onClick={() => alignElements('center-v')} title="Í∞ÄÏö¥Îç∞(ÏÑ∏Î°ú)">‚Üï</button>
                                                <button className="align-btn" onClick={() => alignElements('bottom')} title="ÏïÑÎûò">‚Üì</button>
                                            </div>
                                        </div>
                                    )}

                                    {/* ÏÇ≠Ï†ú Î≤ÑÌäº */}
                                    <button
                                        className="btn-primary"
                                        style={{ width: '100%', marginTop: '16px', background: '#ef4444' }}
                                        onClick={deleteElement}
                                        disabled={element.locked}
                                    >
                                        üóëÔ∏è ÏÇ≠Ï†ú
                                    </button>
                                </div>
                            );
                        })()}
                    </div>

                    {/* Ïª®ÌÖçÏä§Ìä∏ Î©îÎâ¥ */}
                    {contextMenu && (
                        <div 
                            className="context-menu" 
                            style={{ left: contextMenu.x, top: contextMenu.y }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <div className="context-menu-item" onClick={duplicateElement}>
                                üìã Î≥µÏ†ú (Ctrl+D)
                            </div>
                            <div className="context-menu-item" onClick={deleteElement}>
                                üóëÔ∏è ÏÇ≠Ï†ú (Delete)
                            </div>
                            <div className="context-menu-divider"></div>
                            <div className="context-menu-item" onClick={toggleLock}>
                                {elements.find(el => el.id === selectedElement)?.locked ? 'üîì Ïû†Í∏à Ìï¥Ï†ú' : 'üîí Ïû†Í∏à'}
                            </div>
                            <div className="context-menu-divider"></div>
                            <div className="context-menu-item" onClick={() => moveLayer(elements.findIndex(el => el.id === selectedElement), -1)}>
                                ‚Üë ÏïûÏúºÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞
                            </div>
                            <div className="context-menu-item" onClick={() => moveLayer(elements.findIndex(el => el.id === selectedElement), 1)}>
                                ‚Üì Îí§Î°ú Î≥¥ÎÇ¥Í∏∞
                            </div>
                        </div>
                    )}

                    {/* Î≤ÑÏ†Ñ Ìå®ÎÑê */}
                    {showVersions && (
                        <div className="side-panel open">
                            <div className="side-panel-header">
                                <h3>Î≤ÑÏ†Ñ ÌûàÏä§ÌÜ†Î¶¨</h3>
                                <button className="btn-secondary" onClick={() => setShowVersions(false)}>
                                    ‚úï
                                </button>
                            </div>
                            <div className="side-panel-content">
                                {versions.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">üìú</div>
                                        <div>Î≤ÑÏ†ÑÏù¥ ÏóÜÏäµÎãàÎã§</div>
                                    </div>
                                ) : (
                                    versions.map(version => (
                                        <div
                                            key={version.id}
                                            className="version-item"
                                            onClick={() => handleRestoreVersion(version.id)}
                                        >
                                            <div style={{ fontWeight: '600', marginBottom: '4px' }}>
                                                Î≤ÑÏ†Ñ {version.version_number}
                                            </div>
                                            <div style={{ fontSize: '12px', color: '#666' }}>
                                                {version.created_by_name}
                                            </div>
                                            <div style={{ fontSize: '11px', color: '#999', marginTop: '4px' }}>
                                                {new Date(version.created_at).toLocaleString('ko-KR')}
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    )}

                    {/* Î†àÏù¥Ïñ¥ Ìå®ÎÑê */}
                    {showLayers && (
                        <div className="side-panel open">
                            <div className="side-panel-header">
                                <h3>Î†àÏù¥Ïñ¥</h3>
                                <button className="btn-secondary" onClick={() => setShowLayers(false)}>
                                    ‚úï
                                </button>
                            </div>
                            <div className="side-panel-content">
                                {elements.length === 0 ? (
                                    <div className="empty-state">
                                        <div className="empty-state-icon">üóÇÔ∏è</div>
                                        <div>Î†àÏù¥Ïñ¥Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                                    </div>
                                ) : (
                                    [...elements].reverse().map((element, index) => {
                                        const actualIndex = elements.length - 1 - index;
                                        return (
                                            <div
                                                key={element.id}
                                                className={`layer-item ${selectedElement === element.id ? 'selected' : ''} ${element.locked ? 'locked' : ''}`}
                                                onClick={() => !element.locked && setSelectedElement(element.id)}
                                            >
                                                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '8px' }}>
                                                    <div style={{ fontWeight: '600' }}>
                                                        {element.locked && 'üîí '}
                                                        {element.type === 'text' ? element.text : element.type}
                                                    </div>
                                                    <div style={{ fontSize: '11px', color: '#999' }}>
                                                        {Math.round((element.opacity || 1) * 100)}%
                                                    </div>
                                                </div>
                                                <div className="layer-controls">
                                                    <button
                                                        className="layer-btn"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            moveLayer(actualIndex, -1);
                                                        }}
                                                        disabled={actualIndex === 0}
                                                    >
                                                        ‚Üë
                                                    </button>
                                                    <button
                                                        className="layer-btn"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            moveLayer(actualIndex, 1);
                                                        }}
                                                        disabled={actualIndex === elements.length - 1}
                                                    >
                                                        ‚Üì
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </div>
                    )}

                    {/* Ìë∏ÌÑ∞ */}
                    <div className="footer">
                        <div className="zoom-controls">
                            <button 
                                className="toolbar-btn" 
                                onClick={() => setZoom(Math.max(10, zoom - 10))}
                            >
                                ‚àí
                            </button>
                            <span style={{ fontSize: '14px', minWidth: '60px', textAlign: 'center' }}>
                                {zoom}%
                            </span>
                            <button 
                                className="toolbar-btn" 
                                onClick={() => setZoom(Math.min(200, zoom + 10))}
                            >
                                +
                            </button>
                        </div>
                        <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                            <div style={{ fontSize: '12px', color: '#999' }}>
                                ÎßàÏßÄÎßâ Ï†ÄÏû•: {lastSaved.toLocaleTimeString('ko-KR')}
                            </div>
                            <div style={{ fontSize: '12px', color: '#666' }}>
                                ÏöîÏÜå: {elements.length}Í∞ú
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Editor />, document.getElementById('root'));
    </script>
</body>
</html>